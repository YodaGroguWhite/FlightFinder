<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8">
  <title>Flight Finder ¬∑ MOW ‚Üí üåç</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --bg: #0f172a;
      --card: #020617;
      --accent: #22c55e;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 32px 16px;
    }
    .app {
      width: 100%;
      max-width: 900px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
      padding: 24px 24px 28px;
      backdrop-filter: blur(18px);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 24px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 span {
      font-size: 18px;
      color: var(--muted);
      font-weight: 400;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: var(--primary-soft);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 18px;
    }
    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }
    .grid {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 20px;
    }
    @media (max-width: 780px) {
      .grid { grid-template-columns: 1fr; }
    }
    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
    }
    input, button, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }
    button {
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: white;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
      box-shadow: 0 14px 35px rgba(37, 99, 235, 0.45);
    }
    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 18px 45px rgba(37, 99, 235, 0.6);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      font-size: 12px;
      cursor: pointer;
      color: var(--muted);
    }
    .chip:hover {
      border-color: var(--primary);
      color: var(--primary-soft);
    }
    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .results {
      margin-top: 8px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .card {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), rgba(15, 23, 42, 0.96));
      padding: 12px 14px;
      margin-bottom: 10px;
      display: grid;
      grid-template-columns: 2fr 1.5fr;
      gap: 10px;
      align-items: center;
    }
    @media (max-width: 640px) {
      .card { grid-template-columns: 1fr; }
    }
    .route {
      font-size: 15px;
      font-weight: 600;
    }
    .meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .price {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      text-align: right;
    }
    .btn-aff {
      margin-top: 6px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: var(--primary-soft);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-aff span {
      font-size: 14px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 11px;
      color: var(--muted);
      margin-right: 6px;
      margin-top: 4px;
    }
    .calendar {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
    }
    .day {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 6px 8px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }
    .day-best {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }
    .small {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    .status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .status.error { color: var(--danger); }
  </style>
</head>
<body>
<div class="app">
  <div class="badge">
    <div class="badge-dot"></div>
    FLIGHT FINDER ¬∑ MOW ‚Üí üåç ¬∑ AVIASALES API
  </div>

  <h1>
    Flight Finder
    <span>Moscow ‚Üí anywhere</span>
  </h1>

  <div class="grid">
    <!-- LEFT: controls -->
    <div>
      <div style="margin-bottom: 12px;">
        <label for="dest">Destination (IATA ali mesto)</label>
        <input id="dest" list="destinations" placeholder="MLE, CDG, BCN, FCO...">
        <datalist id="destinations">
          <option value="MLE">Maldives (MLE)</option>
          <option value="CDG">Paris (CDG)</option>
          <option value="BCN">Barcelona (BCN)</option>
          <option value="FCO">Rome (FCO)</option>
          <option value="DXB">Dubai (DXB)</option>
          <option value="BKK">Bangkok (BKK)</option>
          <option value="SIN">Singapore (SIN)</option>
        </datalist>
        <div class="btn-row">
          <div class="chip" onclick="setDest('MLE')">Maldives (MLE)</div>
          <div class="chip" onclick="setDest('FCO')">Rome (FCO)</div>
          <div class="chip" onclick="setDest('BCN')">Barcelona (BCN)</div>
          <div class="chip" onclick="setDest('CDG')">Paris (CDG)</div>
        </div>
      </div>

      <div style="margin-bottom: 12px;">
        <label for="date">Departure date</label>
        <input id="date" type="date">
      </div>

      <div style="margin-bottom: 12px;">
        <label for="days">Cheapest days window</label>
        <select id="days">
          <option value="3">¬±3 days</option>
          <option value="5">¬±5 days</option>
          <option value="7" selected>¬±7 days</option>
          <option value="14">¬±14 days</option>
        </select>
        <div class="small">Prika≈æe najcenej≈°e lete v okolici izbranega datuma.</div>
      </div>

      <button onclick="search()">
        üîç Najdi lete
      </button>

      <div class="status" id="status"></div>
    </div>

    <!-- RIGHT: results -->
    <div>
      <div class="section-title">Najdeni leti</div>
      <div id="results" class="results"></div>

      <div class="section-title" style="margin-top: 16px;">Najcenej≈°i dnevi</div>
      <div id="calendar" class="calendar"></div>
    </div>
  </div>
</div>

<script>
function setDest(code) {
  document.getElementById("dest").value = code;
}

function formatDate(d) {
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  return dt.toISOString().slice(0, 10);
}

function buildAviasalesLink(origin, destination, departureDate) {
  const dt = new Date(departureDate);
  const dd = String(dt.getDate()).padStart(2, "0");
  const mm = String(dt.getMonth() + 1).padStart(2, "0");
  return `https://www.aviasales.ru/search/${origin}${dd}${mm}${destination}1`;
}

async function search() {
  const dest = document.getElementById("dest").value.trim().toUpperCase();
  const date = document.getElementById("date").value;
  const days = document.getElementById("days").value;
  const statusEl = document.getElementById("status");
  const resultsEl = document.getElementById("results");
  const calendarEl = document.getElementById("calendar");

  if (!dest || !date) {
    alert("Vnesi destinacijo in datum.");
    return;
  }

  statusEl.textContent = "I≈°ƒçem lete...";
  statusEl.classList.remove("error");
  resultsEl.innerHTML = "";
  calendarEl.innerHTML = "";

  const url = `/api/flights?origin=MOW&destination=${encodeURIComponent(dest)}&departure_at=${encodeURIComponent(date)}&days=${encodeURIComponent(days)}`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();

    if (!data.data || data.data.length === 0) {
      statusEl.textContent = "Ni rezultatov za izbrane parametre.";
      return;
    }

    statusEl.textContent = `Najdenih ${data.data.length} rezultatov.`;

    const tickets = [...data.data].sort((a, b) => a.price - b.price);

    resultsEl.innerHTML = "";
    tickets.slice(0, 10).forEach(t => {
      const link = buildAviasalesLink(t.origin, t.destination, t.departure_at);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div>
          <div class="route">${t.origin} ‚Üí ${t.destination}</div>
          <div class="meta">
            Departure: ${formatDate(t.departure_at)}<br>
            Airline: ${t.airline || "N/A"} ¬∑ Flight: ${t.flight_number || "N/A"}
          </div>
          <div>
            <span class="pill">Direct: ${t.transfers === 0 ? "Yes" : "No / " + t.transfers}</span>
            <span class="pill">Duration: ${t.duration || "?"} min</span>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="price">${t.price} ${t.currency}</div>
          <a class="btn-aff" href="${link}" target="_blank" rel="noopener noreferrer">
            <span>‚úà</span> Open in Aviasales
          </a>
        </div>
      `;
      resultsEl.appendChild(card);
    });

    const byDate = {};
    tickets.forEach(t => {
      const d = formatDate(t.departure_at);
      if (!byDate[d] || t.price < byDate[d].price) {
        byDate[d] = t;
      }
    });

    const dates = Object.keys(byDate).sort();
    if (dates.length) {
      const minPrice = Math.min(...dates.map(d => byDate[d].price));
      dates.forEach(d => {
        const t = byDate[d];
        const div = document.createElement("div");
        div.className = "day" + (t.price === minPrice ? " day-best" : "");
        div.innerHTML = `
          <div><strong>${d}</strong></div>
          <div>${t.price} ${t.currency}</div>
          <div class="small">${t.origin} ‚Üí ${t.destination}</div>
        `;
        calendarEl.appendChild(div);
      });
    }

  } catch (err) {
    statusEl.textContent = "Napaka pri API klicu.";
    statusEl.classList.add("error");
  }
}
</script>
</body>
</html>
